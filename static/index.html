import React, { useState, useEffect } from 'react';
import { Shield, Check, X, Monitor, Key, Clock, AlertCircle } from 'lucide-react';

const OTPControlPanel = () => {
  const [devices, setDevices] = useState([]);
  const [newDevice, setNewDevice] = useState({ name: '', otp: '' });
  const [accessLogs, setAccessLogs] = useState([]);
  const [activeTab, setActiveTab] = useState('devices');
  const [loading, setLoading] = useState(false);

  // URL de la API - usa la URL de Render
  const API_URL = 'https://otp-api-kf7h.onrender.com/api';
  
  useEffect(() => {
    loadData();
    const interval = setInterval(loadData, 5000);
    return () => clearInterval(interval);
  }, []);

  const loadData = async () => {
    try {
      const response = await fetch(`${API_URL}/devices`);
      const data = await response.json();
      setDevices(data.devices || []);
      setAccessLogs(data.logs || []);
    } catch (error) {
      console.error('Error conectando con API:', error);
    }
  };

  const generateOTP = () => {
    return Math.floor(100000 + Math.random() * 900000).toString();
  };

  const addDevice = async () => {
    if (!newDevice.name.trim()) {
      alert('Por favor ingresa el nombre del dispositivo');
      return;
    }

    setLoading(true);
    const otp = generateOTP();
    const device = {
      name: newDevice.name.trim(),
      otp: otp,
      enabled: true
    };

    try {
      const response = await fetch(`${API_URL}/devices`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(device)
      });
      
      if (response.ok) {
        await loadData();
        setNewDevice({ name: '', otp: '' });
        alert(`‚úÖ Dispositivo agregado exitosamente!\n\nNombre: ${device.name}\nOTP: ${otp}\n\n‚ö†Ô∏è Guarda este c√≥digo, lo necesitar√°s para autenticarte.`);
      }
    } catch (error) {
      console.error('Error agregando dispositivo:', error);
      alert('‚ùå Error conectando con el servidor. Verifica que el servidor est√© activo.');
    } finally {
      setLoading(false);
    }
  };

  const toggleDevice = async (deviceId) => {
    const device = devices.find(d => d.id === deviceId);
    
    try {
      const response = await fetch(`${API_URL}/devices/${deviceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: !device.enabled })
      });
      
      if (response.ok) {
        await loadData();
        alert(`‚úÖ Dispositivo ${!device.enabled ? 'activado' : 'bloqueado'} correctamente`);
      }
    } catch (error) {
      console.error('Error actualizando dispositivo:', error);
      alert('‚ùå Error al actualizar dispositivo');
    }
  };

  const regenerateOTP = async (deviceId) => {
    const newOTP = generateOTP();
    
    try {
      const response = await fetch(`${API_URL}/devices/${deviceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ otp: newOTP })
      });
      
      if (response.ok) {
        await loadData();
        alert(`‚úÖ Nuevo OTP generado: ${newOTP}\n\n‚ö†Ô∏è El c√≥digo anterior ya no funcionar√°. Actualiza tu aplicaci√≥n con este nuevo c√≥digo.`);
      }
    } catch (error) {
      console.error('Error regenerando OTP:', error);
      alert('‚ùå Error al generar nuevo OTP');
    }
  };

  const deleteDevice = async (deviceId) => {
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este dispositivo?\n\nEsta acci√≥n no se puede deshacer y el dispositivo perder√° acceso permanentemente.')) return;
    
    try {
      const response = await fetch(`${API_URL}/devices/${deviceId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        await loadData();
        alert('‚úÖ Dispositivo eliminado correctamente');
      }
    } catch (error) {
      console.error('Error eliminando dispositivo:', error);
      alert('‚ùå Error al eliminar dispositivo');
    }
  };

  const formatDate = (isoString) => {
    if (!isoString) return 'Nunca';
    const date = new Date(isoString);
    return date.toLocaleString('es-ES', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20">
          <div className="flex items-center gap-4">
            <div className="bg-gradient-to-br from-purple-500 to-pink-500 p-3 rounded-xl">
              <Shield className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-white">Sistema OTP - Control Remoto</h1>
              <p className="text-purple-200">Gestiona el acceso a tus aplicaciones desde cualquier lugar</p>
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex gap-4 mb-6">
          <button
            onClick={() => setActiveTab('devices')}
            className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${
              activeTab === 'devices'
                ? 'bg-white text-purple-900 shadow-lg'
                : 'bg-white/10 text-white hover:bg-white/20'
            }`}
          >
            <Monitor className="w-5 h-5" />
            Dispositivos
          </button>
          <button
            onClick={() => setActiveTab('logs')}
            className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold transition-all ${
              activeTab === 'logs'
                ? 'bg-white text-purple-900 shadow-lg'
                : 'bg-white/10 text-white hover:bg-white/20'
            }`}
          >
            <Clock className="w-5 h-5" />
            Registro
          </button>
        </div>

        {/* Content */}
        {activeTab === 'devices' && (
          <div className="space-y-6">
            {/* Agregar Nuevo Dispositivo */}
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
              <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <Key className="w-6 h-6" />
                Agregar Nuevo Dispositivo
              </h2>
              <div className="flex gap-4">
                <input
                  type="text"
                  placeholder="Nombre del PC (ej: ASC-RAD-PC1, LAPTOP-OFICINA)"
                  value={newDevice.name}
                  onChange={(e) => setNewDevice({ ...newDevice, name: e.target.value })}
                  className="flex-1 px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  onKeyPress={(e) => e.key === 'Enter' && addDevice()}
                  disabled={loading}
                />
                <button
                  onClick={addDevice}
                  disabled={loading}
                  className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-xl hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? '‚è≥ Generando...' : 'Generar OTP'}
                </button>
              </div>
            </div>

            {/* Lista de Dispositivos */}
            <div className="grid gap-4">
              {devices.length === 0 ? (
                <div className="bg-white/5 backdrop-blur-lg rounded-2xl p-12 border border-white/10 text-center">
                  <AlertCircle className="w-16 h-16 text-white/30 mx-auto mb-4" />
                  <p className="text-white/50 text-lg">No hay dispositivos registrados</p>
                  <p className="text-white/30 text-sm mt-2">Agrega tu primer dispositivo para comenzar</p>
                </div>
              ) : (
                devices.map(device => (
                  <div
                    key={device.id}
                    className={`bg-white/10 backdrop-blur-lg rounded-2xl p-6 border transition-all ${
                      device.enabled
                        ? 'border-green-400/50 shadow-lg shadow-green-500/20'
                        : 'border-red-400/50 opacity-75'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <Monitor className="w-6 h-6 text-white" />
                          <h3 className="text-xl font-bold text-white">{device.name}</h3>
                          {device.enabled ? (
                            <span className="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm font-semibold flex items-center gap-1">
                              <Check className="w-4 h-4" />
                              Activo
                            </span>
                          ) : (
                            <span className="px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-sm font-semibold flex items-center gap-1">
                              <X className="w-4 h-4" />
                              Bloqueado
                            </span>
                          )}
                        </div>
                        
                        <div className="space-y-2 mt-4">
                          <div className="flex items-center gap-2">
                            <span className="text-white/50 text-sm">OTP Actual:</span>
                            <code className="px-4 py-2 bg-black/30 text-green-300 font-mono text-lg rounded-lg border border-white/10">
                              {device.otp}
                            </code>
                          </div>
                          <div className="text-white/50 text-sm">
                            Creado: {formatDate(device.createdAt)}
                          </div>
                          {device.lastUsed && (
                            <div className="text-white/50 text-sm">
                              √öltimo uso: {formatDate(device.lastUsed)}
                            </div>
                          )}
                        </div>
                      </div>

                      <div className="flex flex-col gap-2 ml-4">
                        <button
                          onClick={() => toggleDevice(device.id)}
                          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                            device.enabled
                              ? 'bg-red-500/20 text-red-300 hover:bg-red-500/30'
                              : 'bg-green-500/20 text-green-300 hover:bg-green-500/30'
                          }`}
                        >
                          {device.enabled ? 'Bloquear' : 'Activar'}
                        </button>
                        <button
                          onClick={() => regenerateOTP(device.id)}
                          className="px-4 py-2 bg-purple-500/20 text-purple-300 rounded-lg font-semibold hover:bg-purple-500/30 transition-all"
                        >
                          Nuevo OTP
                        </button>
                        <button
                          onClick={() => deleteDevice(device.id)}
                          className="px-4 py-2 bg-white/10 text-white/50 rounded-lg font-semibold hover:bg-white/20 transition-all"
                        >
                          Eliminar
                        </button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {activeTab === 'logs' && (
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h2 className="text-2xl font-bold text-white mb-4 flex items-center gap-2">
              <Clock className="w-6 h-6" />
              Registro de Actividad
            </h2>
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {accessLogs.length === 0 ? (
                <p className="text-white/50 text-center py-8">No hay registros a√∫n</p>
              ) : (
                accessLogs.map((log, idx) => (
                  <div
                    key={idx}
                    className="flex items-center justify-between p-4 bg-white/5 rounded-lg border border-white/10"
                  >
                    <div>
                      <span className="text-white font-semibold">{log.device}</span>
                      <span className="text-white/50 mx-2">‚Ä¢</span>
                      <span className="text-white/70">{log.action}</span>
                    </div>
                    <span className="text-white/50 text-sm">{formatDate(log.timestamp)}</span>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* Info */}
        <div className="bg-blue-500/10 backdrop-blur-lg rounded-2xl p-6 border border-blue-400/30 mt-6">
          <h3 className="text-xl font-bold text-white mb-3 flex items-center gap-2">
            <AlertCircle className="w-5 h-5 text-blue-300" />
            Estado del Sistema
          </h3>
          <div className="text-white/70 space-y-2">
            <p>‚úÖ <strong>Servidor API:</strong> <code className="bg-black/30 px-2 py-1 rounded text-green-300">https://otp-api-kf7h.onrender.com</code></p>
            <p>üîÑ <strong>Actualizaci√≥n autom√°tica:</strong> Cada 5 segundos</p>
            <p>üåê <strong>Acceso:</strong> Disponible desde cualquier dispositivo con internet</p>
            <p>üîí <strong>Control remoto:</strong> Bloquea/desbloquea dispositivos en tiempo real</p>
          </div>
          
          <div className="mt-4 p-4 bg-purple-500/10 rounded-lg border border-purple-400/30">
            <p className="text-white font-semibold mb-2">üì± C√≥mo usar:</p>
            <ol className="text-white/70 text-sm space-y-1 ml-4 list-decimal">
              <li>Agrega un dispositivo con el nombre exacto de tu PC</li>
              <li>Copia el OTP de 6 d√≠gitos generado</li>
              <li>√ösalo en tu aplicaci√≥n Python para autenticarte</li>
              <li>Gestiona accesos desde este panel en cualquier momento</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  );
};

export default OTPControlPanel;
